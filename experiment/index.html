<!DOCTYPE html>
<html>

<head>
  <title>Fruit-picking game</title>
  <script src="jspsych/jspsych.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-html-slider-response.js"></script>
  <script src="jspsych/plugin-image-keyboard.js"></script>
  <script src="jspsych/plugin-survey-likert.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <script src="jspsych/plugin-instructions.js"></script>
  <script src='jspsych/plugin-survey-multi-choice.js'></script>
  <script src='jspsych/plugin-survey-html-form.js'></script>
  <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />

  <script src='jspsych/consent.js'></script>
  <script src='jspsych/feedback_demographics.js'></script>
  <script src='jspsych/utils.js'></script>

  <script src='https://proliferate.alps.science/static/js/proliferate.js'></script>

  <style>
    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 20%;
    }

    .tree {
      margin-right: 10px;
      margin-left: 10px;
      width: 300px;
    }

    .fruit {
      position: absolute;
      left: 50%;
      top: 18%;
      transform: translate(-50%, -50%);
      z-index: 1;
      width: 150px;
    }

    .instructions {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <img src="img/tree-1.png" class="tree" id="option-0">
    <img src="img/tree-2.png" class="tree" id="option-1">
    <img src="img/tree-3.png" class="tree" id="option-2">
  </div>

  <div class="feedback" id="feedback"></div>

  <script>

    $(document).ready(function () {
      resizeElements();
    });

    $(window).resize(function () {
      resizeElements();
    });

    function resizeElements() {
      $('.tree').width('20vw');
      $('.fruit').width('10vw');
    }

    var jsPsych = initJsPsych({
      override_safe_mode: true,
      default_iti: 150,
      on_finish: function () {
        var data = jsPsych.data.get()

                // submit
                proliferate.submit({                    
                 "trials": data.values()});

                $('#jspsych-content').css('margin-top', 'auto');
                $('#jspsych-content').html('<div style="margin: auto;"> <p>' +
                    ' Thank you for participating in this experiment! </p>' +
                    '<p> Redirecting you back to Prolific... </p>');

                setTimeout(function(){location.href = "https://app.prolific.com/submissions/complete?cc=CBB97AX6"}, 200);
      }
    });

    var condition = get_url_param("condition"); //this sets the variable "condition" to whatever is passed as part of the URL

    // Initialize an empty array to store the timeline of events in the experiment
    var timeline = [];

  // ************************
  // ***** INSTRUCTIONS *****
  // ************************

  var instructions_pages = [
    `<img src='img/instructions01.png' style='width:60vw';<./img>`,
    `<img src='img/instructions02.png' style='width:60vw';<./img>`,
    `<img src='img/instructions03.png' style='width:60vw';<./img>`,
    `<img src='img/instructionsBonus.png' style='width:60vw';<./img>`,
    `<img src='img/instructions04.png' style='width:60vw';<./img>`,
    `<img src='img/instructions05.png' style='width:60vw';<./img>`,
    `<img src='img/instructions06.png' style='width:60vw';<./img>`
  ];

  // Add condition-specific instruction pages
  if (condition == 1) {
    instructions_pages.push(`<img src='img/instructions08.png' style='width:60vw';<./img>`);
  } else if (condition == 2) {
    instructions_pages.push(`<img src='img/instructions072.png' style='width:60vw';<./img>`);
  } else if (condition == 3) {
    instructions_pages.push(`<img src='img/instructions073.png' style='width:60vw';<./img>`);
  } else if (condition == 4) {
    instructions_pages.push(`<img src='img/instructions074.png' style='width:60vw';<./img>`);
  }

  var instructions = {
    type: jsPsychInstructions,
    pages: instructions_pages,
    show_clickable_nav: true,
    button_label_previous: "Previous",
    button_label_next: "Next"
  };

    const comprehension = {
      type: jsPsychSurveyMultiChoice,
      questions: [
        {
          prompt: 'On each trial you will select a tree using the left, up, or right arrow keys.',
          options: ['True', 'False']
        },
        {
          prompt: 'You will receive 2 points for ripe fruit and 0 points for rotten fruit.',
          options: ['True', 'False']
        },
        {
          prompt: 'Some trees are better than others, but sometimes you will still get rotten fruit from good trees and ripe fruit from bad trees.',
          options: ['True', 'False']
        }
      ],
      preamble: 'Please answer a few comprehension questions so we know' +
        ' that you understand the setup.',
      on_finish: function (data) {
        data.correct = (data.response["Q0"] == "True" && data.response["Q1"] == "False" && data.response["Q2"] == "True");
      }
    }

    const fail_comprehension = {
      timeline: [{
        type: jsPsychHtmlButtonResponse,
        stimulus: 'Unfortunately, you missed some of the comprehension ' +
          'questions.</p> <p> Please review the instructions again.',
        choices: ['Review'],
      }],
      conditional_function: function () {
        var data = jsPsych.data.get().last(1).values()[0];
        return !(data.correct);
      }
    }

    const loop_node = {
      timeline: [
        instructions,
        comprehension,
        fail_comprehension
      ],
      loop_function: function (data) {
        var data = jsPsych.data.get().last(1).values()[0];
        return !(data.correct);
      }
    }
    
    
     var start = {
      type: jsPsychInstructions,
      pages: [
        `<p>Well done! You answered all the comprehension questions correctly.</p> <p>Please proceed to the next page to begin the game.</p>`
      ],
      show_clickable_nav: true,
      button_label_next: "Next"

    }

    // Create an array of file paths for the images of the different fruit
    var fruit = ['img/apple-high.png', 'img/apple-neg.png'];
    // Create an array of file paths for the images of the different trees
    var trees = ['img/tree-1.png', 'img/tree-2.png', 'img/tree-3.png'];
    var tree_options = {
      'arrowleft': 'option-0',
      'arrowup': 'option-1',
      'arrowright': 'option-2'
    };

    // Initialize a variable to keep track of the total number of points earned 
    // in the experiment
    var totalPoints = 0;

    // *********************
    // ***** MAIN TRIAL*****
    // *********************
    var trialCounter = 0; // Counter for tracking the current trial
    var totalMultipleChoiceTrials = 0; // Counter for limiting to 10 multiple choice trials
    var part1_break = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        if (condition == 3) {
          return '<p>This concludes part 1 of the experiment.</p> <p>You will now continue with the trials just like you did before, but you will no longer be asked to report your feelings of regret.</p>';
        } else if (condition == 4) {
          return '<p>This concludes part 1 of the experiment.</p> <p>You will now continue with the trials just like you did before, reporting your feelings of regret every time you pick rotten fruit.</p>';
        }
      },
      choices: ['Continue']
    };

    // var tree1_fruit_high = 0;
    // var tree1_fruit_low = 0;
    // var tree2_fruit_high = 0;
    // var tree2_fruit_low = 0;
    // var tree3_fruit_high = 0;
    // var tree3_fruit_low = 0;

    var tree_probs = jsPsych.randomization.shuffle([
        [0.7, 0.3],
        [0.2, 0.8],
        [0.5, 0.5]
      ]);

    // Adjust the timeline structure to include the part 1 break after 30 trials
    for (var i = 0; i < 60; i++) {

      var trial_1 = {
        type: jsPsychHtmlKeyboardResponse,
        choices: ['arrowleft', 'arrowup', 'arrowright'],
        stimulus: function () {
          var options = '';
          for (var j = 0; j < 3; j++) {
            options += '<img src="' + trees[j] + '" class="tree" id="option-' + j + '">';
          }
          return options;
        },
        
        response_ends_trial: true,
        on_finish: function (data) {
          var option = trees[data.response];
          var index = trees.indexOf(option);
          var tree_id = tree_options[data.response];
          var index = 0;
          if (data.response == 'arrowleft') {
            index = 0; 
          } else if (data.response == 'arrowup') {
            index = 1; 
          } else if (data.response == 'arrowright') {
            index = 2;
          }
          var chosen_tree_prob = tree_probs[index][0];
          // Generate a random number between 0 and 1 to determine fruit outcome
          var random_value = Math.random();
          var fruit_prob;
          if (random_value < chosen_tree_prob) {
            fruit_prob = 'img/apple-high.png'; // Ripe fruit
          } else {
            fruit_prob = 'img/apple-neg.png';  // Rotten fruit
          }
          var points = 0;
          if (fruit_prob == 'img/apple-high.png') {
            points = 1;
          } else if (fruit_prob == 'img/apple-neg.png') {
            points = 0;
          }

          var pointsDisplay = document.getElementById("pointsDisplay");
          if (pointsDisplay) {
            pointsDisplay.parentNode.removeChild(pointsDisplay);
          }

          pointsDisplay = document.createElement("div");
          pointsDisplay.style.position = "absolute";
          pointsDisplay.style.top = "10px";
          pointsDisplay.style.right = "10px";
          pointsDisplay.style.fontSize = "24px";
          pointsDisplay.style.fontWeight = "bold";
          pointsDisplay.id = "pointsDisplay";
          document.body.appendChild(pointsDisplay);

          totalPoints += points;
          pointsDisplay.textContent = "Total points: " + totalPoints;

          trialCounter += 1;

          var fruitElement = document.createElement("img");
          fruitElement.src = fruit_prob;
          fruitElement.classList.add("fruit");
          if (data.response == 'arrowleft') {
            fruitElement.style.left = "27%";
          } else if (data.response == 'arrowup') {
            fruitElement.style.left = "50%";
          } else if (data.response == 'arrowright') {
            fruitElement.style.left = "73%";
          }
          document.body.appendChild(fruitElement);

          setTimeout(function () {
            fruitElement.remove();
          }, 500);

          // Update counters based on the chosen tree and fruit result
          // if (data.response == 'arrowleft') { // Tree 1
          //   if (fruit_prob == 'img/apple-high.png') {
          //     tree1_fruit_high++;
          //   } else {
          //     tree1_fruit_low++;
          //   }
          // } else if (data.response == 'arrowup') { // Tree 2
          //   if (fruit_prob == 'img/apple-high.png') {
          //     tree2_fruit_high++;
          //   } else {
          //     tree2_fruit_low++;
          //   }
          // } else if (data.response == 'arrowright') { // Tree 3
          //   if (fruit_prob == 'img/apple-high.png') {
          //     tree3_fruit_high++;
          //   } else {
          //     tree3_fruit_low++;
          //   }
          // }
          // console.log(tree_probs)

          // Log the updated counts for each tree to the console
          // console.log(`Tree 1: ${tree1_fruit_high} high, ${tree1_fruit_low} low`);
          // console.log(`Tree 2: ${tree2_fruit_high} high, ${tree2_fruit_low} low`);
          // console.log(`Tree 3: ${tree3_fruit_high} high, ${tree3_fruit_low} low`);

          var chosenTree = "undefined";
          if (data.response == "arrowleft") {
            chosenTree = '<img src="img/tree-1.png" style="width:200px;"></img><p>How much do you regret this choice?</p>';
          } else if (data.response == "arrowup") {
            chosenTree = '<img src="img/tree-2.png" style="width:200px;"></img><p>How much do you regret this choice?</p>';
          } else if (data.response == "arrowright") {
            chosenTree = '<img src="img/tree-3.png" style="width:200px;"></img><p>How much do you regret this choice?</p>';
          }

          jsPsych.data.addDataToLastTrial({
            fruit: fruit_prob,
            points: points,
            totalpoints: totalPoints,
            tree: chosenTree,
            tree_probabilities: {
              tree_1: tree_probs[0],
              tree_2: tree_probs[1],
              tree_3: tree_probs[2]
            }
            });
        }
      };

      var likert_scale = [
        "Not at all",
        "A little",
        "Moderately",
        "A lot"
      ];

      var multipleChoiceTrial = {
        type: jsPsychHtmlSliderResponse,
        stimulus: function () {
          var last_trial_data = jsPsych.data.getLastTrialData().values()[0];
          var chosen_fruit = '<div><img src="' + last_trial_data.fruit + '" style="width:100px;"></div>';
          var chosen_tree = '<div>' + last_trial_data.tree + '</div>';
          return chosen_fruit + chosen_tree;
        },
        require_movement: true,
        min: 0,
        max: 100,
        step: 1,
        slider_width: 200,
        labels: ['Not at all', 'Very much']
      };

      var if_node = {
        timeline: [multipleChoiceTrial],
        conditional_function: function () {
          var data = jsPsych.data.get().last(1).values()[0];
          if (data.points == 0) {
            if (condition == 2) { // Condition 2: Multiple choice in all 60 trials
              return true;
            } else if (condition == 3 && trialCounter <= 30) { // Condition 3: Multiple choice only in first half
              totalMultipleChoiceTrials += 1;
              return true;
            } else if (condition == 4 && trialCounter > 30) { // Condition 4: Multiple choice only in second half
              totalMultipleChoiceTrials += 1;
              return true;
            }
          }
          return false;
        }
      };

      if (i == 29 && (condition == 3 || condition == 4)) {
        timeline.push(trial_1, if_node, part1_break);
      } else {
        if (condition == 2 || condition == 3 || condition == 4) {
          timeline.push(trial_1, if_node);
        } else {
          timeline.push(trial_1);
        }
      }
}

    // Nest trial within 3 blocks
    var block = {
      timeline: timeline,
      repetitions: 1
    };

    jsPsych.run([consent, loop_node, start, block, feedback_demographics],)

  </script>
</body>

</html>